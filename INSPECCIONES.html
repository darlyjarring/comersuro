<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Comersur - Reporte en Horas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 15px; }
        .container { max-width: 1200px; margin: auto; }
        .header { background: #1a237e; color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; }
        #inputSection { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
        textarea { width: 100%; height: 80px; border: 1px solid #1a237e; border-radius: 6px; padding: 10px; margin-bottom: 10px; }
        .btn-main { background: #2e7d32; color: white; border: none; padding: 12px 40px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #dashboardSection { display: none; }
        .kpi-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px; }
        .kpi-card { background: white; padding: 15px; border-radius: 8px; text-align: center; border-top: 5px solid #1a237e; }
        .kpi-card p { margin: 8px 0 0; font-size: 28px; font-weight: bold; color: #1a237e; }
        .charts-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 15px; margin-bottom: 15px; }
        .chart-box { background: white; padding: 15px; border-radius: 8px; height: 350px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .table-container { background: white; padding: 15px; border-radius: 8px; max-height: 250px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f1f3f4; position: sticky; top: 0; padding: 10px; text-align: left; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div class="container">
    <div class="header"><h1>ðŸ“Š DASHBOARD DE INSPECCIONES (FORMATO HORAS)</h1></div>

    <div id="inputSection">
        <textarea id="rawInput" placeholder="Pega tus datos de Excel aquÃ­..."></textarea>
        <button class="btn-main" onclick="generar()">ACTUALIZAR REPORTES</button>
    </div>

    <div id="dashboardSection">
        <div class="kpi-row">
            <div class="kpi-card"><h3>TOTAL CONTENEDORES</h3><p id="k-total">0</p></div>
            <div class="kpi-card"><h3>TIEMPO PROMEDIO</h3><p id="k-avg">0:00</p></div>
            <div class="kpi-card"><h3>TIEMPO TOTAL PERIODO</h3><p id="k-sum">0:00</p></div>
        </div>

        <div class="charts-grid">
            <div class="chart-box"><canvas id="lineChart"></canvas></div>
            <div class="chart-box"><canvas id="pieChart"></canvas></div>
        </div>

        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr><th>FECHA</th><th>CONTENEDOR</th><th>DURACIÃ“N</th><th>DESTINO</th><th>TERMINAL</th></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let charts = {};

    function generar() {
        const input = document.getElementById('rawInput').value.trim();
        if (!input) return;

        const rows = input.split('\n');
        let data = [], totalMins = 0;
        let terms = {}, trend = {};

        rows.forEach(row => {
            const c = row.split('\t');
            if (c.length < 11) return;

            // Extraer tiempo de la columna F (Ã­ndice 5)
            let tParts = c[5].trim().split(':');
            let mins = (parseInt(tParts[0]) || 0) * 60 + (parseInt(tParts[1]) || 0);
            totalMins += mins;

            const fecha = c[0];
            trend[fecha] = (trend[fecha] || 0) + mins;
            terms[c[11]] = (terms[c[11]] || 0) + 1;

            data.push({ fecha, cont: c[2], tiempo: c[5], dest: c[9], term: c[11] });
        });

        document.getElementById('inputSection').style.display = 'none';
        document.getElementById('dashboardSection').style.display = 'block';

        // Llenar KPIs
        document.getElementById('k-total').innerText = data.length;
        let avg = Math.round(totalMins / data.length);
        document.getElementById('k-avg').innerText = `${Math.floor(avg/60)}h ${avg%60}m`;
        document.getElementById('k-sum').innerText = `${Math.floor(totalMins/60)}h ${totalMins%60}m`;

        // Tabla
        document.getElementById('tableBody').innerHTML = data.map(d => 
            `<tr><td>${d.fecha}</td><td>${d.cont}</td><td><b>${d.tiempo}</b></td><td>${d.dest}</td><td>${d.term}</td></tr>`
        ).join('');

        render(trend, terms);
    }

    function render(trend, terms) {
        // Convertir minutos de tendencia a horas decimales para el grÃ¡fico
        const labels = Object.keys(trend);
        const valuesInHours = Object.values(trend).map(m => (m / 60).toFixed(2));

        if(charts.line) charts.line.destroy();
        charts.line = new Chart(document.getElementById('lineChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Horas de InspecciÃ³n',
                    data: valuesInHours,
                    borderColor: '#1a237e',
                    backgroundColor: 'rgba(26,35,126,0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    y: {
                        ticks: { callback: function(value) { return value + 'h'; } },
                        title: { display: true, text: 'Horas Totales del DÃ­a' }
                    }
                },
                plugins: { title: { display: true, text: 'CARGA DE TRABAJO DIARIA (HORAS)' } }
            }
        });

        if(charts.pie) charts.pie.destroy();
        const total = Object.values(terms).reduce((a,b)=>a+b,0);
        charts.pie = new Chart(document.getElementById('pieChart'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(terms).map(k => `${k}: ${Math.round((terms[k]/total)*100)}%`),
                datasets: [{ data: Object.values(terms), backgroundColor: ['#1a237e', '#c62828', '#2e7d32', '#fbc02d'] }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'PARTICIPACIÃ“N TERMINAL (%)' } }
            }
        });
    }
</script>
</body>
</html>
