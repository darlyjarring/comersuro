<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Control de Inspecciones</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #eef2f3; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: auto; }
        .header { background: #003366; color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; }
        
        /* Área de entrada */
        #inputSection { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; }
        textarea { width: 100%; height: 150px; border: 2px dashed #003366; border-radius: 8px; padding: 10px; margin-bottom: 15px; resize: none; }
        .btn-main { background: #008cba; color: white; border: none; padding: 15px 40px; font-size: 18px; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        .btn-main:hover { background: #005f7a; }

        /* Dashboard oculto inicialmente */
        #dashboardSection { display: none; }
        
        /* KPIs */
        .kpi-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 20px; border-radius: 8px; text-align: center; border-bottom: 5px solid #003366; }
        .kpi-card h3 { margin: 0; font-size: 14px; color: #666; }
        .kpi-card p { margin: 10px 0 0; font-size: 32px; font-weight: bold; color: #003366; }

        /* Gráficos */
        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-container { background: white; padding: 20px; border-radius: 8px; height: 350px; }

        /* Tabla */
        .table-container { background: white; padding: 20px; border-radius: 8px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #003366; color: white; padding: 10px; text-align: left; }
        td { border-bottom: 1px solid #ddd; padding: 10px; }
        tr:hover { background: #f1f1f1; }

        .btn-reset { background: #f44336; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>CONTROL DE INSPECCIONES LOGÍSTICAS</h1>
    </div>

    <div id="inputSection">
        <p>Selecciona tus datos en Excel, cópialos y pégalos aquí abajo:</p>
        <textarea id="rawInput" placeholder="Pega aquí los datos..."></textarea>
        <br>
        <button class="btn-main" onclick="generarDashboard()">GENERAR REPORTES</button>
    </div>

    <div id="dashboardSection">
        <button class="btn-reset" onclick="resetear()">← PEGAR OTROS DATOS</button>
        
        <div class="kpi-row">
            <div class="kpi-card"><h3>TOTAL CONTENEDORES</h3><p id="totalCount">0</p></div>
            <div class="kpi-card"><h3>TIEMPO PROMEDIO</h3><p id="avgTime">00:00</p></div>
            <div class="kpi-card"><h3>SEMANAS REPORTADAS</h3><p id="weekCount">0</p></div>
        </div>

        <div class="charts-row">
            <div class="chart-container"><canvas id="destChart"></canvas></div>
            <div class="chart-container"><canvas id="termChart"></canvas></div>
        </div>

        <div class="table-container">
            <h3>Detalle de Carga Procesada</h3>
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Fecha</th><th>Contenedor</th><th>Inicio</th><th>Fin</th><th>Tiempo</th><th>Exportadora</th><th>Destino</th><th>Terminal</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let dChart, tChart;

    function generarDashboard() {
        const input = document.getElementById('rawInput').value.trim();
        if (!input) return alert("Pega algunos datos primero");

        const rows = input.split('\n');
        const data = [];
        let totalMinutes = 0;
        let destMap = {};
        let termMap = {};
        let weeks = new Set();

        rows.forEach(row => {
            const cols = row.split('\t');
            if (cols.length < 10) return;

            // Mapeo según tu tabla: Fecha(0), Prog(1), Cont(2), Ini(3), Fin(4), Tiempo(5)...
            const entry = {
                fecha: cols[0],
                contenedor: cols[2],
                inicio: cols[3],
                fin: cols[4],
                tiempo: cols[5],
                exportadora: cols[6],
                semana: cols[8],
                destino: cols[9],
                terminal: cols[11]
            };

            // Calcular minutos para promedio
            const tParts = entry.tiempo.split(':');
            if (tParts.length === 2) {
                totalMinutes += (parseInt(tParts[0]) * 60) + parseInt(tParts[1]);
            }

            destMap[entry.destino] = (destMap[entry.destino] || 0) + 1;
            termMap[entry.terminal] = (termMap[entry.terminal] || 0) + 1;
            weeks.add(entry.semana);
            data.push(entry);
        });

        if (data.length === 0) return alert("Formato de datos no reconocido.");

        // Mostrar dashboard y ocultar input
        document.getElementById('inputSection').style.display = 'none';
        document.getElementById('dashboardSection').style.display = 'block';

        // Llenar KPIs
        document.getElementById('totalCount').innerText = data.length;
        document.getElementById('weekCount').innerText = weeks.size;
        
        const avgMins = totalMinutes / data.length;
        const h = Math.floor(avgMins / 60);
        const m = Math.round(avgMins % 60);
        document.getElementById('avgTime').innerText = `${h}:${m.toString().padStart(2, '0')}`;

        // Llenar Tabla
        const body = document.getElementById('tableBody');
        body.innerHTML = "";
        data.forEach(item => {
            body.innerHTML += `<tr>
                <td>${item.fecha}</td><td>${item.contenedor}</td><td>${item.inicio}</td>
                <td>${item.fin}</td><td><b>${item.tiempo}</b></td><td>${item.exportadora}</td>
                <td>${item.destino}</td><td>${item.terminal}</td>
            </tr>`;
        });

        actualizarGraficos(destMap, termMap);
    }

    function actualizarGraficos(destData, termData) {
        if (dChart) dChart.destroy();
        if (tChart) tChart.destroy();

        dChart = new Chart(document.getElementById('destChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(destData),
                datasets: [{ label: 'Inspecciones por Destino', data: Object.values(destData), backgroundColor: '#003366' }]
            },
            options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'DESTINOS PRINCIPALES' } } }
        });

        tChart = new Chart(document.getElementById('termChart'), {
            type: 'pie',
            data: {
                labels: Object.keys(termData),
                datasets: [{ data: Object.values(termData), backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'] }]
            },
            options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'DISTRIBUCIÓN POR TERMINAL' } } }
        });
    }

    function resetear() {
        document.getElementById('inputSection').style.display = 'block';
        document.getElementById('dashboardSection').style.display = 'none';
        document.getElementById('rawInput').value = "";
    }
</script>
</body>
</html>
