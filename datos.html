<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COMERSURO PRO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --azul: #004a87; }
        body { background: #f4f7f6; font-size: 14px; padding-bottom: 80px; }
        .header-app { background: var(--azul); color: white; padding: 10px; text-align: center; font-weight: bold; }
        .step-content { display: none; padding: 10px; }
        .step-content.active { display: block; }
        .card-custom { background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .scroll { height: calc(100vh - 220px); overflow-y: auto; }
        
        /* Estilos Resumen */
        .resumen-card { font-size: 0.75rem; border-left: 4px solid var(--azul); margin-bottom: 8px; padding: 8px; background: white; }
        .badge-estado { cursor: pointer; user-select: none; transition: 0.2s; }
        .badge-estado:active { transform: scale(0.9); }

        .nav-bottom { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; height: 70px; }
        .nav-item { flex: 1; border: none; background: none; color: #888; font-size: 0.7rem; text-align: center; padding-top: 10px; }
        .nav-item.active { color: var(--azul); font-weight: bold; }
        .nav-item span { display: block; font-size: 1.2rem; }
    </style>
</head>
<body>

<div class="header-app">LOG√çSTICA COMERSURO</div>

<div id="step1" class="step-content active">
    <div class="card-custom">
        <h6>Nuevo Pedido</h6>
        <input type="text" id="vapor" class="form-control mb-2" placeholder="Nave/Vapor">
        <input type="text" id="linea" class="form-control mb-2" placeholder="L√≠nea">
        <input type="text" id="booking_p" class="form-control mb-2" placeholder="Booking">
        <input type="text" id="marca" class="form-control mb-2" placeholder="Marca">
        <input type="number" id="cant" class="form-control mb-2" placeholder="Cantidad">
        <input type="date" id="fecha" class="form-control mb-2" onchange="calcSemana()">
        <input type="hidden" id="sem">
        <button onclick="guardarPedido()" class="btn btn-primary w-100">Guardar Pedido</button>
    </div>
</div>

<div id="step2" class="step-content">
    <div class="d-flex justify-content-between mb-2">
        <span class="fw-bold">LISTA</span>
        <button onclick="cargarDatos()" class="btn btn-sm btn-light border">üîÑ</button>
    </div>
    <div id="lista" class="scroll"></div>
</div>

<div id="step3" class="step-content">
    <div class="card-custom border-success border-top border-4">
        <h6>Registro de Contenedor</h6>
        <input type="text" id="idSel" class="form-control mb-2 bg-light" readonly>
        <input type="text" id="cont" class="form-control mb-2" placeholder="Contenedor">
        <input type="text" id="transp" class="form-control mb-2" placeholder="Transportista">
        <input type="date" id="fecha_carga" class="form-control mb-3">
        <button onclick="guardarDetalle()" class="btn btn-success w-100">Finalizar Registro</button>
    </div>
</div>

<div id="step4" class="step-content">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="fw-bold">RESUMEN DETALLADO</span>
        <button onclick="exportarExcel()" class="btn btn-sm btn-success">Excel üì•</button>
    </div>
    <div id="listaResumen" class="scroll"></div>
</div>

<nav class="nav-bottom">
    <button class="nav-item active" onclick="showStep(1, this)"><span>üìù</span>Pedido</button>
    <button class="nav-item" onclick="showStep(2, this)"><span>üìã</span>Lista</button>
    <button class="nav-item" onclick="showStep(3, this)"><span>üì¶</span>Carga</button>
    <button class="nav-item" onclick="showStep(4, this)"><span>üìä</span>Resumen</button>
</nav>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyvddi6UJTHcB-KWz3_OZmZHjjvP3senGq36wUi5XCszLWAJd_WX2l16OEnChTdJCWlPw/exec"; // REEMPLAZAR
    let pedidos = [], detalles = [];

    async function cargarDatos() {
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            pedidos = data.pedidos || [];
            detalles = data.detalles || [];
            render();
            renderResumen();
        } catch(e) { console.log(e); }
    }

    function render() {
        const l = document.getElementById('lista');
        l.innerHTML = "";
        pedidos.forEach(p => {
            const d = document.createElement('div');
            d.className = 'card-custom';
            d.innerHTML = `<b>${p.vapor}</b> | BK: ${p.booking}<br><small>${p.registrados}/${p.cantidad} - ${p.linea}</small>`;
            d.onclick = () => { document.getElementById('idSel').value = p.id; showStep(3); };
            l.appendChild(d);
        });
    }

    function renderResumen() {
        const r = document.getElementById('listaResumen');
        r.innerHTML = "";
        detalles.slice().reverse().forEach(d => {
            const div = document.createElement('div');
            div.className = 'resumen-card shadow-sm';
            div.innerHTML = `
                <div class="row">
                    <div class="col-7">
                        <b>Nave:</b> ${d.vapor}<br>
                        <b>BK:</b> ${d.booking} | <b>Marca:</b> ${d.marca}<br>
                        <b>Cont:</b> ${d.contenedor}<br>
                        <b>Transp:</b> ${d.transp}
                    </div>
                    <div class="col-5 text-end">
                        <small>Ped: ${d.fechaPed}</small><br>
                        <small>Reg: ${d.fechaReg}</small><br>
                        <span class="badge ${d.blasti === 'Blasti' ? 'bg-primary' : 'bg-warning'} mt-2 badge-estado" 
                              ondblclick="cambiarEstado(${d.fila}, '${d.blasti}')">
                              ${d.blasti}
                        </span>
                        <div style="font-size:9px" class="text-muted">Doble clic para cambiar</div>
                    </div>
                </div>
            `;
            r.appendChild(div);
        });
    }

    async function cambiarEstado(fila, estadoActual) {
        const nuevo = estadoActual === "Blasti" ? "Campo" : "Blasti";
        if(!confirm("¬øCambiar estado a " + nuevo + "?")) return;
        
        await fetch(SCRIPT_URL, { method:'POST', mode:'no-cors', body:JSON.stringify({action:"cambiarEstado", fila: fila, nuevoEstado: nuevo})});
        alert("Estado actualizado");
        cargarDatos();
    }

    async function guardarPedido() {
        const p = {
            action: "nuevoPedido",
            id: "P-" + Date.now().toString().slice(-4),
            vapor: document.getElementById('vapor').value,
            linea: document.getElementById('linea').value,
            booking: document.getElementById('booking_p').value,
            marca: document.getElementById('marca').value,
            cantidad: document.getElementById('cant').value,
            fecha: document.getElementById('fecha').value.split("-").reverse().join("/"),
            semana: document.getElementById('sem').value
        };
        await fetch(SCRIPT_URL, { method:'POST', mode:'no-cors', body:JSON.stringify(p)});
        alert("Pedido Creado"); cargarDatos(); showStep(2);
    }

    async function guardarDetalle() {
        const d = {
            action: "completarDetalle",
            idPedido: document.getElementById('idSel').value,
            contenedor: document.getElementById('cont').value,
            fecha: document.getElementById('fecha_carga').value.split("-").reverse().join("/"),
            transp: document.getElementById('transp').value,
            blasti: "Blasti"
        };
        await fetch(SCRIPT_URL, { method:'POST', mode:'no-cors', body:JSON.stringify(d)});
        alert("Contenedor Registrado"); 
        document.getElementById('cont').value = "";
        cargarDatos(); showStep(4);
    }

    function showStep(s, btn) {
        document.querySelectorAll('.step-content').forEach(x => x.classList.remove('active'));
        document.getElementById('step' + s).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
    }

    function calcSemana() {
        const v = document.getElementById('fecha').value; if(!v) return;
        const d = new Date(v); d.setHours(0,0,0,0); d.setDate(d.getDate() + 4 - (d.getDay() || 7));
        const s = Math.ceil((((d - new Date(d.getFullYear(), 0, 1)) / 86400000) + 1) / 7);
        document.getElementById('sem').value = s;
    }

    function exportarExcel() {
        let csv = "\uFEFFNave,Booking,Marca,Linea,Fecha Pedido,Contenedor,Fecha Registro,Transporte,Estado\n";
        detalles.forEach(d => {
            csv += `${d.vapor},${d.booking},${d.marca},${d.linea},${d.fechaPed},${d.contenedor},${d.fechaReg},${d.transp},${d.blasti}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Reporte_Comersuro.csv";
        link.click();
    }

    window.onload = cargarDatos;
</script>
</body>
</html>
