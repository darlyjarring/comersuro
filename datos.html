<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"> 
    <title>COMERSURO LOG√çSTICA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --azul: #004a87; --gris: #f8f9fa; }
        body { background-color: var(--gris); font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 85px; overflow-x: hidden; }
        .header-app { background: var(--azul); color: white; padding: 15px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .container-mobile { padding: 15px; }
        .step-content { display: none; }
        .step-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Estilo tarjetas tipo M√≥vil */
        .card-custom { background: white; border-radius: 15px; padding: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 15px; border: none; }
        .form-control { height: 50px; border-radius: 12px; margin-bottom: 12px; font-size: 16px; border: 1px solid #ddd; }
        .btn-main { height: 50px; border-radius: 12px; font-weight: bold; font-size: 16px; width: 100%; transition: 0.2s; }
        
        /* Lista de Pedidos */
        .p-item { border-left: 6px solid var(--azul); }
        .vapor-title { font-size: 1.1rem; font-weight: bold; color: var(--azul); text-transform: uppercase; }
        .scroll { height: calc(100vh - 220px); overflow-y: auto; padding-right: 5px; }

        /* Resumen con Doble Clic */
        .resumen-card { font-size: 0.8rem; border-bottom: 1px solid #eee; padding: 12px 0; }
        .resumen-card b { color: #333; }
        .estado-pill { cursor: pointer; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 0.7rem; display: inline-block; user-select: none; }
        .blasti { background: #e3f2fd; color: #007bff; border: 1px solid #007bff; }
        .campo { background: #fff3e0; color: #ef6c00; border: 1px solid #ef6c00; }

        /* Navegaci√≥n Inferior */
        .nav-bottom { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; height: 75px; border-top: 1px solid #eee; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-item { flex: 1; border: none; background: none; color: #a0a0a0; font-size: 0.75rem; text-align: center; padding-top: 12px; }
        .nav-item.active { color: var(--azul); font-weight: bold; }
        .nav-item span { display: block; font-size: 1.5rem; margin-bottom: 2px; }
    </style>
</head>
<body>

<div class="header-app">COMERSURO LOG√çSTICA</div>

<div class="container-mobile">
    
    <div id="step1" class="step-content active">
        <div class="card-custom">
            <h6 class="mb-3 fw-bold">1. Crear Pedido</h6>
            <input type="text" id="vapor" class="form-control" placeholder="Nombre de la Nave">
            <input type="text" id="linea" class="form-control" placeholder="L√≠nea Naviera">
            <input type="text" id="booking_p" class="form-control" placeholder="N√∫mero de Booking">
            <input type="text" id="marca" class="form-control" placeholder="Marca (Opcional)">
            <div class="row g-2">
                <div class="col-6"><input type="number" id="cant" class="form-control" placeholder="Cantidad"></div>
                <div class="col-6"><input type="date" id="fecha" class="form-control" onchange="calcSemana()"></div>
            </div>
            <input type="hidden" id="sem">
            <button onclick="guardarPedido()" class="btn btn-primary btn-main shadow">Guardar Pedido</button>
        </div>
    </div>

    <div id="step2" class="step-content">
        <div class="d-flex justify-content-between mb-3">
            <span class="fw-bold text-muted small">PEDIDOS ACTIVOS</span>
            <button onclick="cargarDatos()" class="btn btn-sm btn-light">Refrescar üîÑ</button>
        </div>
        <div id="lista" class="scroll"></div>
    </div>

    <div id="step3" class="step-content">
        <div class="card-custom border-top border-success border-4">
            <h6 class="mb-3 fw-bold text-success">2. Registrar Carga</h6>
            <input type="text" id="idSel" class="form-control bg-light text-center fw-bold" readonly>
            <input type="text" id="cont" class="form-control" placeholder="Contenedor (Ej: ABCU1234)">
            <input type="text" id="transp" class="form-control" placeholder="Nombre del Transporte">
            <input type="date" id="fecha_carga" class="form-control">
            <button onclick="guardarDetalle()" class="btn btn-success btn-main shadow">Finalizar Registro</button>
        </div>
    </div>

    <div id="step4" class="step-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="fw-bold text-muted small">RESUMEN HIST√ìRICO</span>
            <button onclick="exportarExcel()" class="btn btn-sm btn-success fw-bold">Excel üì•</button>
        </div>
        <div id="listaResumen" class="scroll card-custom"></div>
    </div>

</div>

<nav class="nav-bottom">
    <button class="nav-item active" onclick="showStep(1, this)"><span>üìù</span>Pedido</button>
    <button class="nav-item" onclick="showStep(2, this)"><span>üìã</span>Lista</button>
    <button class="nav-item" onclick="showStep(3, this)"><span>üì¶</span>Carga</button>
    <button class="nav-item" onclick="showStep(4, this)"><span>üìä</span>Resumen</button>
</nav>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyvddi6UJTHcB-KWz3_OZmZHjjvP3senGq36wUi5XCszLWAJd_WX2l16OEnChTdJCWlPw/exec"; // REEMPLAZA ESTO
    let pedidos = [], detalles = [];

    async function cargarDatos() {
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            pedidos = data.pedidos || [];
            detalles = data.detalles || [];
            render();
            renderResumen();
        } catch(e) { console.log(e); }
    }

   // RENDER DE LISTA CON BLOQUEO VISUAL
function render() {
    const l = document.getElementById('lista');
    l.innerHTML = "";
    pedidos.forEach(p => {
        const d = document.createElement('div');
        // Si est√° completado, usamos una clase gris y quitamos el puntero
        d.className = `card-custom ${p.completado ? 'bg-light opacity-75 border-success' : 'p-item'}`;
        d.style.cursor = p.completado ? 'not-allowed' : 'pointer';
        
        d.innerHTML = `
            <div class="d-flex justify-content-between">
                <span class="vapor-title ${p.completado ? 'text-muted' : ''}">${p.vapor}</span>
                <span class="badge ${p.completado ? 'bg-success' : 'bg-primary'} rounded-pill">
                    ${p.registrados} / ${p.cantidad}
                </span>
            </div>
            <div class="text-muted small mt-1">BK: ${p.booking} | ${p.linea}</div>
            ${p.completado ? '<div class="text-success fw-bold small mt-1">‚úì PEDIDO COMPLETADO</div>' : ''}
        `;

        d.onclick = () => { 
            if(p.completado) {
                alert("Este pedido ya alcanz√≥ el l√≠mite de contenedores (" + p.cantidad + ")");
            } else {
                document.getElementById('idSel').value = p.id; 
                showStep(3); 
            }
        };
        l.appendChild(d);
    });
}

    function renderResumen() {
    const r = document.getElementById('listaResumen');
    r.innerHTML = "";

    // Funci√≥n interna para limpiar el formato ISO en el momento
    const limpiar = (f) => {
        if (!f) return "S/F";
        // Si contiene la "T" del formato ISO (2026-01-28T05:00...)
        if (typeof f === 'string' && f.includes('T')) {
            let soloFecha = f.split('T')[0]; // Toma "2026-01-28"
            let partes = soloFecha.split('-');
            return `${partes[2]}/${partes[1]}/${partes[0]}`; // Retorna "28/01/2026"
        }
        return f; // Si ya est√° limpia, la deja igual
    };

    detalles.slice().reverse().forEach(d => {
        const item = document.createElement('div');
        item.className = 'resumen-card';
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <b>${d.vapor}</b> | BK: ${d.booking}<br>
                    <span class="text-muted">Marca: ${d.marca} | L√≠nea: ${d.linea}</span><br>
                    <b>Cont:</b> ${d.contenedor} | <b>Trans:</b> ${d.transp}<br>
                    <small>P: ${limpiar(d.fechaPed)} | R: ${limpiar(d.fechaReg)}</small>
                </div>
                <div class="text-center">
                    <div class="estado-pill ${d.blasti.toLowerCase()}" 
                         ondblclick="cambiarEstado(${d.fila}, '${d.blasti}')">
                         ${d.blasti}
                    </div>
                </div>
            </div>
        `;
        r.appendChild(item);
    });
}

    async function cambiarEstado(fila, actual) {
        const nuevo = actual === "Blasti" ? "Campo" : "Blasti";
        if(!confirm("Cambiar estado a " + nuevo + "?")) return;
        await fetch(SCRIPT_URL, { method:'POST', mode:'no-cors', body:JSON.stringify({action:"cambiarEstado", fila: fila, nuevoEstado: nuevo})});
        alert("Actualizado!");
        cargarDatos();
    }

    // --- GUARDAR NUEVO PEDIDO CON BLOQUEO Y LIMPIEZA ---
async function guardarPedido() {
    const btn = event.target;
    const v = document.getElementById('vapor').value;
    const b = document.getElementById('booking_p').value;
    const c = document.getElementById('cant').value;
    
    if(!v || !b || !c) return alert("Completa los campos obligatorios");

    // BLOQUEO DEL BOT√ìN
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Guardando...';

    const p = {
        action: "nuevoPedido", 
        id: "P-" + Date.now().toString().slice(-4),
        vapor: v, 
        linea: document.getElementById('linea').value,
        booking: b, 
        marca: document.getElementById('marca').value,
        cantidad: c, 
        fecha: document.getElementById('fecha').value.split("-").reverse().join("/"),
        semana: document.getElementById('sem').value
    };

    try {
        await fetch(SCRIPT_URL, { method:'POST', mode:'no-cors', body:JSON.stringify(p)});
        
        // LIMPIEZA DE CAMPOS
        document.getElementById('vapor').value = "";
        document.getElementById('linea').value = "";
        document.getElementById('booking_p').value = "";
        document.getElementById('marca').value = "";
        document.getElementById('cant').value = "";
        document.getElementById('fecha').value = "";
        
        alert("‚úÖ Pedido guardado con √©xito");
        await cargarDatos(); // Refrescar lista
        showStep(2);
    } catch(e) {
        alert("‚ùå Error al guardar. Intenta de nuevo.");
    } finally {
        // DESBLOQUEO DEL BOT√ìN
        btn.disabled = false;
        btn.innerHTML = "Guardar Pedido";
    }
}

// GUARDAR DETALLE CON VALIDACI√ìN DE DOBLE CLIC Y LIMPIEZA
async function guardarDetalle() {
    const btn = event.target;
    const id = document.getElementById('idSel').value;
    const cont = document.getElementById('cont').value;
    const trans = document.getElementById('transp').value;
    const fecha = document.getElementById('fecha_carga').value;
    
    if(!id || !cont || !fecha) return alert("Faltan datos obligatorios.");

    // 1. BLOQUEO VISUAL
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Registrando...';

    const d = {
        action: "completarDetalle", 
        idPedido: id,
        contenedor: cont.toUpperCase(), 
        fecha: fecha.split("-").reverse().join("/"),
        transp: trans, 
        blasti: "Blasti"
    };

    try {
        // Enviamos los datos
        fetch(SCRIPT_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify(d) 
        });

        // 2. FORZAR REINICIO (No esperamos al servidor para no quedarnos trabados)
        setTimeout(async () => {
            // Limpieza de campos
            document.getElementById('cont').value = "";
            document.getElementById('transp').value = "";
            document.getElementById('fecha_carga').value = "";
            document.getElementById('idSel').value = "";
            
            // Liberar bot√≥n
            btn.disabled = false;
            btn.innerHTML = "Finalizar Registro";
            
            alert("‚úÖ Registro enviado correctamente");
            
            // Actualizar datos de fondo y volver a la lista
            await cargarDatos(); 
            showStep(2); 
        }, 1000); // 1 segundo de espera es suficiente para el env√≠o

    } catch(e) {
        alert("‚ùå Error al conectar.");
        btn.disabled = false;
        btn.innerHTML = "Finalizar Registro";
    }
}

    function showStep(s, btn) {
        document.querySelectorAll('.step-content').forEach(x => x.classList.remove('active'));
        document.getElementById('step' + s).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active'); else document.querySelectorAll('.nav-item')[s-1].classList.add('active');
        window.scrollTo(0,0);
    }

    function calcSemana() {
        const v = document.getElementById('fecha').value; if(!v) return;
        const d = new Date(v); d.setHours(0,0,0,0); d.setDate(d.getDate() + 4 - (d.getDay() || 7));
        const s = Math.ceil((((d - new Date(d.getFullYear(), 0, 1)) / 86400000) + 1) / 7);
        document.getElementById('sem').value = s;
    }

function exportarExcel() {
    const limpiar = (f) => {
        if (typeof f === 'string' && f.includes('T')) {
            let partes = f.split('T')[0].split('-');
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }
        return f;
    };

    const reporte = detalles.map(d => ({
        "Vapor": d.vapor,
        "Booking": d.booking,
        "Fecha Pedido": limpiar(d.fechaPed),
        "Fecha Registro": limpiar(d.fechaReg),
        "Contenedor": d.contenedor,
        "Transporte": d.transp,
        "Estado": d.blasti
    }));
    
    const ws = XLSX.utils.json_to_sheet(reporte);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Log√≠stica");
    XLSX.writeFile(wb, "Reporte_Comersuro.xlsx");
}

    window.onload = cargarDatos;
</script>
</body>
</html>
