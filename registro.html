<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>comersuro - Control de Pedidos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .pedido-nuevo { background-color: #fff3cd !important; border-left: 5px solid #ffc107; } /* Amarillo */
        .pedido-completo { background-color: #ffffff !important; border-left: 5px solid #198754; } /* Normal/Verde */
        .card-pedido { cursor: pointer; transition: 0.3s; margin-bottom: 10px; }
        .card-pedido:hover { transform: scale(1.02); }
        .header { background: #0078d4; color: white; padding: 15px; }
    </style>
</head>
<body>

<div class="header text-center"><h1>Gestión Logística comersuro</h1></div>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-4">
            <div class="card p-3 shadow-sm">
                <h5>1. Registrar Nuevo Pedido</h5>
                <form id="formPedido">
                    <input type="number" id="cantidad" class="form-control mb-2" placeholder="Cantidad" required>
                    <input type="date" id="fecha" class="form-control mb-2" required>
                    <button type="submit" class="btn btn-primary w-100">Crear Pedido</button>
                </form>
            </div>
        </div>

        <div class="col-md-4">
            <h5>2. Pedidos Existentes</h5>
            <div id="listaVisual" style="max-height: 500px; overflow-y: auto;">
                <p class="text-muted text-center">Cargando pedidos...</p>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-3 shadow-sm">
                <h5>3. Completar Contenedor</h5>
                <form id="formDetalle">
                    <label>ID Seleccionado:</label>
                    <input type="text" id="idSeleccionado" class="form-control mb-2" readonly>
                    <input type="text" id="contenedor" class="form-control mb-2" placeholder="Contenedor" required>
                    <input type="text" id="booking" class="form-control mb-2" placeholder="Booking" required>
                    <button type="submit" class="btn btn-success w-100">Guardar Detalles</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const WEBHOOK_URL = "https://hook.us2.make.com/x7w5fnmcunpxjlny69gqhs12elln1cjx";

    // Simulación de carga (En Make deberías configurar un GET para traer datos reales)
    let pedidosLocal = [];

    async function cargarPedidos() {
        // Aquí llamarías a Make para traer la lista de Excel
        // Por ahora, manejaremos la lógica visual:
        renderizarLista();
    }

    function renderizarLista() {
        const contenedor = document.getElementById('listaVisual');
        contenedor.innerHTML = "";
        pedidosLocal.forEach(p => {
            const div = document.createElement('div');
            div.className = `card card-pedido p-2 shadow-sm ${p.completado ? 'pedido-completo' : 'pedido-nuevo'}`;
            div.innerHTML = `<strong>Pedido #${p.id}</strong><br><small>Cant: ${p.cantidad} | ${p.fecha}</small>`;
            div.onclick = () => seleccionarPedido(p.id);
            contenedor.appendChild(div);
        });
    }

    function seleccionarPedido(id) {
        document.getElementById('idSeleccionado').value = id;
    }

    document.getElementById('formPedido').onsubmit = async (e) => {
        e.preventDefault();
        const nuevo = {
            action: "nuevoPedido",
            id: Date.now().toString().slice(-4), // Genera un ID automático
            cantidad: document.getElementById('cantidad').value,
            fecha: document.getElementById('fecha').value,
            completado: false
        };
        
        pedidosLocal.unshift(nuevo);
        renderizarLista();
        await fetch(WEBHOOK_URL, { method: 'POST', body: JSON.stringify(nuevo) });
        e.target.reset();
    };

    document.getElementById('formDetalle').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('idSeleccionado').value;
        const pedido = pedidosLocal.find(p => p.id === id);
        
        if (pedido) {
            pedido.completado = true; // Cambia el color de amarillo a normal
            renderizarLista();
            await fetch(WEBHOOK_URL, { 
                method: 'POST', 
                body: JSON.stringify({
                    action: "completarDetalle",
                    idPedido: id,
                    contenedor: document.getElementById('contenedor').value,
                    booking: document.getElementById('booking').value
                })
            });
            alert("Contenedor asignado y color actualizado");
            e.target.reset();
            document.getElementById('idSeleccionado').value = "";
        }
    };

    window.onload = cargarPedidos;
</script>
</body>
</html>
