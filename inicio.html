<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Semanal - COMERSURO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --azul: #004a87; --gris: #f8f9fa; }
        body { background: var(--gris); font-family: 'Segoe UI', sans-serif; padding: 20px; }
        .card-kpi { background: white; border-radius: 12px; padding: 20px; border-left: 5px solid var(--azul); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .table-container { background: white; border-radius: 12px; padding: 15px; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .header-title { color: var(--azul); font-weight: bold; margin-bottom: 25px; border-bottom: 2px solid var(--azul); display: inline-block; }
        .badge-campo { background-color: #fff3e0; color: #ef6c00; border: 1px solid #ef6c00; }
        .resumen-texto { font-size: 0.9rem; color: #555; }
    </style>
</head>
<body>

<div class="container-fluid">
    <h2 class="header-title">üìä PANEL DE CONTROL SEMANAL</h2>

    <div class="row mb-4">
        <div class="col-md-3">
            <label class="fw-bold small">SELECCIONAR SEMANA:</label>
            <select id="filtroSemana" class="form-select" onchange="procesarDatos()">
                <option value="">Cargando semanas...</option>
            </select>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card-kpi">
                <small class="text-muted d-block">SEMANA</small>
                <h3 id="kpiSemana">-</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-kpi" style="border-left-color: #28a745;">
                <small class="text-muted d-block">TOTAL CONTENEDORES</small>
                <h3 id="kpiTotal">0</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-kpi" style="border-left-color: #ef6c00;">
                <small class="text-muted d-block">TOTAL A CAMPO</small>
                <h3 id="kpiCampo">0</h3>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-md-5">
            <div class="card-kpi" style="height: 100%;">
                <h6 class="fw-bold mb-3">Distribuci√≥n por Transportista / L√≠nea</h6>
                <canvas id="chartTransporte"></canvas>
                <div id="desgloseLineas" class="mt-4 resumen-texto"></div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="table-container">
                <h6 class="fw-bold mb-3">Detalle de Operaciones</h6>
                <div class="table-responsive" style="max-height: 500px;">
                    <table class="table table-hover align-middle small">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>BOOKING</th>
                                <th>TRANSPORTISTA</th>
                                <th>NAVE / L√çNEA</th>
                                <th>CONTENEDOR</th>
                                <th>REGISTRO</th>
                                <th>VENTOLERA</th>
                                <th>ESTADO</th>
                            </tr>
                        </thead>
                        <tbody id="tablaCuerpo"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyvddi6UJTHcB-KWz3_OZmZHjjvP3senGq36wUi5XCszLWAJd_WX2l16OEnChTdJCWlPw/exec"; // REEMPLAZA CON TU URL
    let datosCompletos = {};
    let chartInstance = null;

    async function obtenerDatos() {
        const res = await fetch(SCRIPT_URL);
        datosCompletos = await res.json();
        poblarSemanas();
    }

    function poblarSemanas() {
        const select = document.getElementById('filtroSemana');
        // Extraer semanas √∫nicas de la lista de pedidos
        const semanas = [...new Set(datosCompletos.pedidos.map(p => p.semana))].sort();
        select.innerHTML = '<option value="">Elegir...</option>';
        semanas.forEach(s => {
            if(s) select.innerHTML += `<option value="${s}">${s}</option>`;
        });
    }

    function procesarDatos() {
        const semBusqueda = document.getElementById('filtroSemana').value;
        if (!semBusqueda) return;

        // 1. Obtener IDs de pedidos que pertenecen a esa semana
        const idsPedidosSemana = datosCompletos.pedidos
            .filter(p => p.semana === semBusqueda)
            .map(p => p.id);

        // 2. Filtrar detalles que correspondan a esos IDs
        const filas = datosCompletos.detalles.filter(d => idsPedidosSemana.includes(d.idPedido));

        // Actualizar KPIs b√°sicos
        document.getElementById('kpiSemana').innerText = semBusqueda;
        document.getElementById('kpiTotal').innerText = filas.length;
        document.getElementById('kpiCampo').innerText = filas.filter(f => f.blasti === 'Campo').length;

        renderTabla(filas);
        generarGrafico(filas);
    }

    function renderTabla(filas) {
        const tbody = document.getElementById('tablaCuerpo');
        tbody.innerHTML = "";
        filas.forEach(f => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="fw-bold">${f.booking}</td>
                <td>${f.transp}</td>
                <td>${f.vapor}<br><small class="text-muted">${f.linea}</small></td>
                <td>${f.contenedor}</td>
                <td>${f.fechaReg}</td>
                <td>${f.ventolera || '---'}</td>
                <td><span class="badge ${f.blasti === 'Campo' ? 'badge-campo' : 'text-primary border'}">${f.blasti}</span></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function generarGrafico(filas) {
        const conteoTransp = {};
        const desglose = {}; // { TRANSPORTISTA: { LINEA: CANTIDAD } }

        filas.forEach(f => {
            // Conteo simple para gr√°fico
            conteoTransp[f.transp] = (conteoTransp[f.transp] || 0) + 1;
            
            // Desglose por l√≠nea
            if (!desglose[f.transp]) desglose[f.transp] = {};
            desglose[f.transp][f.linea] = (desglose[f.transp][f.linea] || 0) + 1;
        });

        // Dibujar Gr√°fico
        const ctx = document.getElementById('chartTransporte').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(conteoTransp),
                datasets: [{
                    data: Object.values(conteoTransp),
                    backgroundColor: ['#004a87', '#28a745', '#ffc107', '#dc3545', '#6c757d']
                }]
            },
            options: { plugins: { legend: { position: 'bottom' } } }
        });

        // Renderizar texto de desglose
        let htmlDesglose = "<strong>Detalle por L√≠nea:</strong><br>";
        for (const [transp, lineas] of Object.entries(desglose)) {
            htmlDesglose += `<div class="mt-2 text-primary fw-bold">${transp} (${conteoTransp[transp]})</div>`;
            for (const [linea, cant] of Object.entries(lineas)) {
                htmlDesglose += `&nbsp;&nbsp;‚Ä¢ ${linea}: ${cant} cont.<br>`;
            }
        }
        document.getElementById('desgloseLineas').innerHTML = htmlDesglose;
    }

    window.onload = obtenerDatos;
</script>

</body>
</html>
